<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Terminal</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="top-bar">
        <div class="logo">MARKET TERMINAL</div>
        <div class="stats">
            <span class="stat-item">ITEMS: <span id="item-count">0</span></span>
            <span class="stat-item">TOTAL QTY: <span id="total-qty">0</span></span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="panel">
                <div class="panel-header">ACTIONS</div>
                <div class="panel-content">
                    <button id="add-btn" class="action-btn">+ NEW ENTRY</button>
                    <button id="refresh-btn" class="action-btn secondary">REFRESH</button>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">FILTERS</div>
                <div class="panel-content">
                    <input type="text" id="search" placeholder="Search items..." class="search-input">
                    <select id="sort" class="select-input">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">Name A-Z</option>
                        <option value="quantity">Quantity</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="table-container">
                <table id="items-table">
                    <thead>
                        <tr>
                            <th>IMAGE</th>
                            <th>NAME</th>
                            <th>QTY</th>
                            <th>NOTE 1</th>
                            <th>NOTE 2</th>
                            <th>NOTE 3</th>
                            <th>TIMESTAMP</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody">
                    </tbody>
                </table>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-icon">â– </div>
                    <p>NO ITEMS IN DATABASE</p>
                    <p class="empty-sub">Click NEW ENTRY to add items</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Item</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="item-form" enctype="multipart/form-data">
                <input type="hidden" id="item-id">
                
                <div class="form-group">
                    <label for="image">Image:</label>
                    <input type="file" id="image" accept="image/*">
                    <div id="image-preview"></div>
                </div>

                <div class="form-group">
                    <label for="name">Name: *</label>
                    <input type="text" id="name" required>
                </div>

                <div class="form-group">
                    <label for="quantity">Quantity: *</label>
                    <input type="number" id="quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label for="note1">Note 1:</label>
                    <textarea id="note1" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="note2">Note 2:</label>
                    <textarea id="note2" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="note3">Note 3:</label>
                    <textarea id="note3" rows="2"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="closeModal()" class="secondary-btn">Cancel</button>
                    <button type="submit" class="primary-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let items = [];
        let editingId = null;

        // Load items on page load
        loadItems();

        async function loadItems() {
            try {
                const response = await fetch('/api/items');
                items = await response.json();
                displayItems();
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        function displayItems() {
            const tbody = document.getElementById('items-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('items-table');
            
            // Update stats
            document.getElementById('item-count').textContent = items.length;
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('total-qty').textContent = totalQty;
            
            // Apply filters
            let filteredItems = filterAndSortItems();
            
            if (filteredItems.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = filteredItems.map(item => {
                const date = new Date(item.timestamp).toLocaleString();
                return `
                    <tr>
                        <td class="img-cell">
                            ${item.image ? `<img src="${item.image}" alt="${item.name}" class="table-image">` : '<div class="no-img">-</div>'}
                        </td>
                        <td class="name-cell">${escapeHtml(item.name)}</td>
                        <td class="qty-cell">${item.quantity}</td>
                        <td class="note-cell">${escapeHtml(item.note1) || '-'}</td>
                        <td class="note-cell">${escapeHtml(item.note2) || '-'}</td>
                        <td class="note-cell">${escapeHtml(item.note3) || '-'}</td>
                        <td class="time-cell">${date}</td>
                        <td class="action-cell">
                            <button onclick="editItem('${item.id}')" class="table-btn edit">EDIT</button>
                            <button onclick="deleteItem('${item.id}')" class="table-btn delete">DELETE</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterAndSortItems() {
            let filtered = [...items];
            
            // Search filter
            const searchTerm = document.getElementById('search').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.note1.toLowerCase().includes(searchTerm) ||
                    item.note2.toLowerCase().includes(searchTerm) ||
                    item.note3.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort
            const sortBy = document.getElementById('sort').value;
            switch(sortBy) {
                case 'newest':
                    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    break;
                case 'name':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'quantity':
                    filtered.sort((a, b) => b.quantity - a.quantity);
                    break;
            }
            
            return filtered;
        }

        document.getElementById('add-btn').addEventListener('click', () => {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add New Item';
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('modal').style.display = 'flex';
        });

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('item-id').value = id;
            document.getElementById('name').value = item.name;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('note1').value = item.note1;
            document.getElementById('note2').value = item.note2;
            document.getElementById('note3').value = item.note3;
            
            if (item.image) {
                document.getElementById('image-preview').innerHTML = `<img src="${item.image}" alt="Preview">`;
            }
            
            document.getElementById('modal').style.display = 'flex';
        }

        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                const response = await fetch(`/api/items/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadItems();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete item');
            }
        }

        document.getElementById('image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('image-preview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('item-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('quantity', document.getElementById('quantity').value);
            formData.append('note1', document.getElementById('note1').value);
            formData.append('note2', document.getElementById('note2').value);
            formData.append('note3', document.getElementById('note3').value);
            
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const url = editingId ? `/api/items/${editingId}` : '/api/items';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (response.ok) {
                    closeModal();
                    await loadItems();
                } else {
                    alert('Failed to save item');
                }
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Failed to save item');
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filter event listeners
        document.getElementById('search').addEventListener('input', displayItems);
        document.getElementById('sort').addEventListener('change', displayItems);
        document.getElementById('refresh-btn').addEventListener('click', loadItems);
        
        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>

