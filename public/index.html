<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Terminal</title>
    <link rel="stylesheet" href="/styles.css">
    <meta name="color-scheme" content="dark light">
    <meta name="theme-color" content="#0b1220">
    <style>
        /* Info overlay + card (centered animated pop-up) */
        .info-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(2,6,11,0.6);
            z-index: 1250;
            opacity: 0;
            transition: opacity 180ms ease;
            pointer-events: none;
        }

        .info-overlay.show {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .info-card {
            width: 820px;
            max-width: 92%;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 30px 80px rgba(2,6,23,0.85);
            transform: translateY(6px) scale(.98);
            opacity: 0;
            transition: transform .18s ease, opacity .18s ease;
            color: #e6eef8;
        }

        .info-card.enter {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .info-card .info-header { display:flex; align-items:center; gap:12px }
        .info-card .info-image { width:120px; height:120px; border-radius:10px; object-fit:cover; background:#091018 }
        .info-card .info-title { font-weight:800; font-size:18px }
        .info-card .info-meta { font-size:13px; color:#9fb3d3 }
        .info-card .info-notes { margin-top:12px; color:#d6e6fb; max-height:260px; overflow:auto }

        .name-link { background: transparent; border: none; color: inherit; font-weight: 600; cursor: pointer; padding: 0; text-align: left; }
    </style>
</head>
<body>
    <div class="market-top">
        <div class="market-brand">MARKET TERMINAL</div>
        <div class="market-controls">
            <select id="region" class="select-input small">
                <option>Jita</option>
                <option>Amarr</option>
                <option>Dodixie</option>
            </select>
            <input id="search" class="search-input small" placeholder="Search items or notes...">
            <button id="refresh-btn" class="icon-btn">⟳</button>
            <button id="add-btn" class="primary-btn small">+ NEW</button>
        </div>
    </div>

    <div class="market-wrap">
        <aside class="market-sidebar">
            <div class="sidebar-section">
                <div class="section-title">CATEGORIES</div>
                <div class="category-add">
                    <input id="new-category" placeholder="Add category..." class="cat-input">
                    <button id="add-category-btn" class="icon-btn">＋</button>
                </div>
                <ul id="category-list" class="category-list">
                    <!-- rendered by JS -->
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="section-title">STATS</div>
                <div class="stat">Items: <span id="item-count">0</span></div>
                <div class="stat">Total Qty: <span id="total-qty">0</span></div>
            </div>

            <div class="sidebar-section actions">
                <button class="secondary-btn" onclick="location.reload()">Quick Sync</button>
            </div>
        </aside>

        <main class="market-main">
            <div class="market-header">
                <div class="market-title">Market Orders</div>
                <div class="market-sub">Compact view — click an item to edit</div>
            </div>

            <div class="table-wrap">
                <table id="items-table" class="market-table">
                    <thead>
                        <tr>
                            <th class="col-img"> </th>
                            <th class="col-name">Name</th>
                            <th class="col-qty">Qty</th>
                            <th class="col-note">Note 1</th>
                            <th class="col-note">Note 2</th>
                            <th class="col-note">Note 3</th>
                            <th class="col-time">Time</th>
                            <th class="col-actions"> </th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody">
                    </tbody>
                </table>

                <div id="empty-state" class="empty-state" style="display:none;">
                    <div class="empty-icon">■</div>
                    <p>NO ITEMS IN DATABASE</p>
                    <p class="empty-sub">Click NEW to add items</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Image preview modal (enlarged icon) -->
    <div id="image-modal" class="image-modal" style="display:none;">
        <div class="image-modal-content">
            <button class="image-close" id="image-close">✕</button>
            <img id="image-modal-img" src="" alt="Preview">
            <div id="image-modal-caption" class="image-caption"></div>
        </div>
    </div>

    <!-- Animated info card (centered overlay) -->
    <div id="info-overlay" class="info-overlay" aria-hidden="true">
        <div id="info-card" class="info-card" role="dialog" aria-modal="true" aria-labelledby="info-title">
            <button id="info-close" class="detail-close" title="Close">✕</button>
            <div class="info-header">
                <img id="info-image" class="info-image" src="" alt="">
                <div style="min-width:0">
                    <div id="info-title" class="info-title">Item name</div>
                    <div id="info-meta" class="info-meta">Category • Qty • time</div>
                </div>
            </div>
            <div id="info-notes" class="info-notes">Notes will appear here.</div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="info-edit" class="primary-btn">Edit</button>
                <button id="info-delete" class="secondary-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal (kept the same structure) -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Item</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="item-form" enctype="multipart/form-data">
                <input type="hidden" id="item-id">

                <div class="form-group">
                    <label for="image">Image:</label>
                    <input type="file" id="image" accept="image/*">
                    <div id="image-preview"></div>
                </div>

                <div class="form-group">
                    <label for="name">Name: *</label>
                    <input type="text" id="name" required>
                </div>

                    <div class="form-group">
                        <label for="quantity">Quantity: *</label>
                        <input type="number" id="quantity" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="category-select">Category:</label>
                        <select id="category-select"></select>
                    </div>

                <div class="form-group">
                    <label for="note1">Note 1:</label>
                    <textarea id="note1" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="note2">Note 2:</label>
                    <textarea id="note2" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="note3">Note 3:</label>
                    <textarea id="note3" rows="2"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="closeModal()" class="secondary-btn">Cancel</button>
                    <button type="submit" class="primary-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- extended script: categories + image preview + preserved behavior ---
        let items = [];
        let editingId = null;
        let categories = [];
        let selectedCategory = 'All';

        // Initialize categories and load items
        loadCategories();
        loadItems();

        function loadCategories() {
            const raw = localStorage.getItem('market_categories');
            if (raw) {
                try { categories = JSON.parse(raw); } catch(e){ categories = null; }
            }
            if (!categories || !Array.isArray(categories) || categories.length === 0) {
                categories = ['All','Ships','Modules','Ammo','Minerals','Blueprints'];
                saveCategories();
            }
            renderCategories();
            populateCategorySelect();
        }

        function saveCategories(){
            localStorage.setItem('market_categories', JSON.stringify(categories));
        }

        function renderCategories(){
            const list = document.getElementById('category-list');
            if(!list) return;
            list.innerHTML = categories.map(cat => {
                const safe = escapeHtml(cat);
                const active = cat === selectedCategory ? 'active' : '';
                const removable = (cat !== 'All') ? `<button data-rem="${safe}" class="cat-remove" title="Remove">✕</button>` : '';
                return `<li class="category category-item ${active}" data-name="${safe}"><span class="cat-name">${safe}</span>${removable}</li>`;
            }).join('');

            // bind events
            document.querySelectorAll('#category-list .category-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    // prevent click when remove pressed
                    if (e.target && e.target.classList.contains('cat-remove')) return;
                    selectedCategory = el.getAttribute('data-name');
                    renderCategories();
                    displayItems();
                    populateCategorySelect();
                });
            });

            document.querySelectorAll('#category-list .cat-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const name = btn.getAttribute('data-rem');
                    removeCategory(name);
                });
            });
        }

        function addCategory(name){
            name = (name||'').trim();
            if(!name) return;
            if(categories.includes(name)) return;
            categories.push(name);
            saveCategories();
            renderCategories();
            populateCategorySelect();
            document.getElementById('new-category').value = '';
        }

        function removeCategory(name){
            if(!name || name === 'All') return;
            const idx = categories.indexOf(name);
            if(idx === -1) return;
            if(!confirm(`Remove category '${name}'? This won't delete items.`)) return;
            categories.splice(idx,1);
            if(selectedCategory === name) selectedCategory = 'All';
            saveCategories();
            renderCategories();
            populateCategorySelect();
            displayItems();
        }

        function populateCategorySelect(){
            const sel = document.getElementById('category-select');
            if(!sel) return;
            sel.innerHTML = categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }

        document.getElementById('add-category-btn').addEventListener('click', () => {
            const v = document.getElementById('new-category').value;
            addCategory(v);
        });

        document.getElementById('new-category').addEventListener('keypress', (e)=>{
            if(e.key === 'Enter'){
                e.preventDefault();
                addCategory(e.target.value);
            }
        });

        async function loadItems() {
            try {
                const response = await fetch('/api/items');
                items = await response.json();
                // ensure category exists on items
                items = items.map(i => ({...i, category: i.category || 'Uncategorized'}));
                if (!categories.includes('Uncategorized')){
                    categories.push('Uncategorized'); saveCategories(); renderCategories(); populateCategorySelect();
                }
                displayItems();
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        function displayItems() {
            const tbody = document.getElementById('items-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('items-table');
            
            // Update stats
            document.getElementById('item-count').textContent = items.length;
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('total-qty').textContent = totalQty;
            
            // Apply filters
            let filteredItems = filterAndSortItems();

            // Category filter
            if (selectedCategory && selectedCategory !== 'All'){
                filteredItems = filteredItems.filter(it => (it.category || 'Uncategorized') === selectedCategory);
            }

            if (filteredItems.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'flex';
                tbody.innerHTML = '';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';

            tbody.innerHTML = filteredItems.map(item => {
                const date = new Date(item.timestamp).toLocaleString();
                const imgCell = item.image ? `<img src="${item.image}" alt="${escapeHtml(item.name)}" class="table-image" data-src="${item.image}" data-name="${escapeHtml(item.name)}">` : '<div class="no-img">-</div>';
                return `
                    <tr class="market-row">
                        <td class="img-cell">${imgCell}</td>
                        <td class="name-cell">${escapeHtml(item.name)}<div class="cat-tag">${escapeHtml(item.category||'Uncategorized')}</div></td>
                        <td class="qty-cell">${item.quantity}</td>
                        <td class="note-cell">${escapeHtml(item.note1) || '-'}</td>
                        <td class="note-cell">${escapeHtml(item.note2) || '-'}</td>
                        <td class="note-cell">${escapeHtml(item.note3) || '-'}</td>
                        <td class="time-cell">${date}</td>
                        <td class="action-cell">
                            <button onclick="editItem('${item.id}')" class="table-btn edit">✎</button>
                            <button onclick="deleteItem('${item.id}')" class="table-btn delete">✕</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // attach image preview handlers
            document.querySelectorAll('#items-tbody .table-image').forEach(img => {
                img.addEventListener('click', () => {
                    openImagePreview(img.getAttribute('data-src'), img.getAttribute('data-name'));
                });
            });
        }
        
        function filterAndSortItems() {
            let filtered = [...items];
            
            // Search filter
            const searchEl = document.getElementById('search');
            const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.note1||'').toLowerCase().includes(searchTerm) ||
                    (item.note2||'').toLowerCase().includes(searchTerm) ||
                    (item.note3||'').toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort fallback to timestamp desc
            filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            return filtered;
        }

        document.getElementById('add-btn').addEventListener('click', () => {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add New Item';
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = '';
            document.getElementById('image-preview').innerHTML = '';
            populateCategorySelect();
            document.getElementById('modal').style.display = 'flex';
        });

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('item-id').value = id;
            document.getElementById('name').value = item.name;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('note1').value = item.note1;
            document.getElementById('note2').value = item.note2;
            document.getElementById('note3').value = item.note3;
            
            populateCategorySelect();
            try { document.getElementById('category-select').value = item.category || 'Uncategorized'; } catch(e){}

            if (item.image) {
                document.getElementById('image-preview').innerHTML = `<img src="${item.image}" alt="Preview">`;
            }
            
            document.getElementById('modal').style.display = 'flex';
        }

        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                const response = await fetch(`/api/items/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadItems();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete item');
            }
        }

        document.getElementById('image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('image-preview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('item-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('quantity', document.getElementById('quantity').value);
            formData.append('note1', document.getElementById('note1').value);
            formData.append('note2', document.getElementById('note2').value);
            formData.append('note3', document.getElementById('note3').value);
            formData.append('category', document.getElementById('category-select').value || 'Uncategorized');
            
            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const url = editingId ? `/api/items/${editingId}` : '/api/items';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (response.ok) {
                    closeModal();
                    await loadItems();
                } else {
                    alert('Failed to save item');
                }
            } catch (error) {
                console.error('Error saving item:', error);
                alert('Failed to save item');
            }
        });

        function openImagePreview(url, name){
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('image-modal-img');
            const cap = document.getElementById('image-modal-caption');
            if(!url) return;
            img.src = url;
            cap.textContent = name || '';
            modal.style.display = 'flex';
        }

        document.getElementById('image-close').addEventListener('click', ()=>{
            document.getElementById('image-modal').style.display = 'none';
            document.getElementById('image-modal-img').src = '';
        });

        // --- Info card popup: show when clicking item name ---
        function showInfoCard(item) {
            const overlay = document.getElementById('info-overlay');
            const card = document.getElementById('info-card');
            if(!card || !overlay) return;
            const img = document.getElementById('info-image');
            const title = document.getElementById('info-title');
            const meta = document.getElementById('info-meta');
            const notes = document.getElementById('info-notes');
            const editBtn = document.getElementById('info-edit');
            const delBtn = document.getElementById('info-delete');

            img.src = item.image || '';
            img.alt = item.name || '';
            title.textContent = item.name || 'Untitled';
            const time = new Date(item.timestamp).toLocaleString();
            meta.textContent = `${item.category || 'Uncategorized'} • ${item.quantity} • ${time}`;
            notes.innerHTML = `
                <div><strong>Note 1:</strong> ${escapeHtml(item.note1 || '-')}</div>
                <div><strong>Note 2:</strong> ${escapeHtml(item.note2 || '-')}</div>
                <div><strong>Note 3:</strong> ${escapeHtml(item.note3 || '-')}</div>
            `;

            // wire actions
            editBtn.onclick = () => { closeInfoCard(); editItem(item.id); };
            delBtn.onclick = async () => {
                if (!confirm('Delete this item?')) return;
                try {
                    const res = await fetch(`/api/items/${item.id}`, { method: 'DELETE' });
                    if (res.ok) { closeInfoCard(); await loadItems(); }
                    else alert('Failed to delete');
                } catch (e) { console.error(e); alert('Failed to delete'); }
            };

            overlay.classList.add('show');
            card.classList.add('enter');
            overlay.setAttribute('aria-hidden','false');

            // focus management
            editBtn.focus();
        }

        function closeInfoCard(){
            const overlay = document.getElementById('info-overlay');
            const card = document.getElementById('info-card');
            if(!card || !overlay) return;
            card.classList.remove('enter');
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden','true');
        }

        document.getElementById('info-close').addEventListener('click', closeInfoCard);
        document.getElementById('info-overlay').addEventListener('click', (e)=>{
            if(e.target === e.currentTarget) closeInfoCard();
        });

        // enhance name cells to be clickable during render
        const originalDisplayItems = displayItems;
        async function displayItemsWithNames() {
            originalDisplayItems();
            // attach handlers for name buttons
            document.querySelectorAll('#items-tbody .name-cell').forEach(td => {
                const btn = td.querySelector('.name-link');
                if(btn) return; // already enhanced
                const text = td.innerHTML;
                // replace leading text with button that opens info card
                const match = td.querySelector('.cat-tag');
                const catHtml = match ? match.outerHTML : '';
                const nameText = td.childNodes[0] ? td.childNodes[0].textContent.trim() : '';
                td.innerHTML = `<button class="name-link">${escapeHtml(nameText)}</button>${catHtml}`;
                const nameBtn = td.querySelector('.name-link');
                nameBtn.addEventListener('click', async (e)=>{
                    // find the row's item id via action button onclick or row contents
                    const row = td.closest('tr');
                    if(!row) return;
                    const editBtn = row.querySelector('.table-btn.edit');
                    // get id from edit button's onclick attribute (editItem('id'))
                    if(editBtn && editBtn.getAttribute('onclick')){
                        const s = editBtn.getAttribute('onclick');
                        const m = s.match(/editItem\('([0-9\-]+)'\)/);
                        if(m){
                            const id = m[1];
                            const item = items.find(i=>i.id===id);
                            if(item) showInfoCard(item);
                        }
                    }
                });
            });
        }

        // override the displayItems reference used earlier
        displayItems = displayItemsWithNames;

        // Close image modal when clicking outside content
        document.getElementById('image-modal').addEventListener('click', (e)=>{
            if(e.target === e.currentTarget){
                e.currentTarget.style.display = 'none';
                document.getElementById('image-modal-img').src = '';
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filter event listeners
        const searchInput = document.getElementById('search');
        if (searchInput) searchInput.addEventListener('input', displayItems);
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) refreshBtn.addEventListener('click', loadItems);
        
        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>